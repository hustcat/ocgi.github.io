<!doctype html><html lang=en-us><head><meta charset=utf-8><title>设置GamerServer缩容的优先级</title><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=generator content="Hugo 0.83.1"><link rel=stylesheet href=https://ocgi.github.io/plugins/bootstrap/bootstrap.min.css><link rel=stylesheet href=https://ocgi.github.io/plugins/themify-icons/themify-icons.css><link rel=icon href=https://ocgi.github.io/images/favicon.png type=image/x-icon><link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel=stylesheet><style>:root{--primary-color:#0052d9;--body-color:#f9f9f9;--text-color:#636363;--text-color-dark:#242738;--white-color:#ffffff;--light-color:#f8f9fa;--font-family:Lato}</style><link href=https://ocgi.github.io/css/style.min.css rel=stylesheet media=screen><script src=https://ocgi.github.io/plugins/jquery/jquery-1.12.4.js></script><script src=https://ocgi.github.io/plugins/jquery/jquery-ui.js></script><script src=https://ocgi.github.io/plugins/bootstrap/bootstrap.min.js></script><script src=https://ocgi.github.io/plugins/match-height/jquery.matchHeight-min.js></script></head><body><header class="shadow-bottom sticky-top bg-white"><nav class="navbar navbar-expand-md navbar-light"><div class=container><a class="navbar-brand px-2" href=/>OCGI</a>
<button class="navbar-toggler border-0" type=button data-toggle=collapse data-target=#navigation aria-controls=navigation aria-expanded=false aria-label="Toggle navigation">
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse text-center" id=navigation><ul class="navbar-nav ml-auto"><li class=nav-item><a class="nav-link text-dark" href=https://ocgi.github.io/en/docs/>Docs</a></li><li class=nav-item><a class="nav-link text-dark" href=https://github.com/ocgi>Github</a></li></ul><select class="lang-list dark" id=select-language onchange="location=this.value"><option id=en value=https://ocgi.github.io/zh/docs/guides/squad-scaledown-priority/ selected>En</option></select></div></div></nav></header><section class="single section-sm pb-0"><div class=container><div class=row><div class=col-lg-3><div class=sidebar><ul class=list-styled><a class=back-btn href=/></a><li data-nav-id=https://ocgi.github.io/zh/ title=Zhs class=sidelist><a href=https://ocgi.github.io/zh/>Zhs</a><ul><li data-nav-id=https://ocgi.github.io/zh/docs/ title="OCGI Documentation" class=sidelist><a href=https://ocgi.github.io/zh/docs/>OCGI Documentation</a><ul><li data-nav-id=https://ocgi.github.io/zh/docs/overview/ title=Overview class=sidelist><a href=https://ocgi.github.io/zh/docs/overview/>Overview</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/installation/ title=Installation class=sidelist><a href=https://ocgi.github.io/zh/docs/installation/>Installation</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/getting-started/ title="Getting Started" class=sidelist><a href=https://ocgi.github.io/zh/docs/getting-started/>Getting Started</a><ul><li data-nav-id=https://ocgi.github.io/zh/docs/getting-started/gameserver/ title=创建GameServer class=sidelist><a href=https://ocgi.github.io/zh/docs/getting-started/gameserver/>创建GameServer</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/getting-started/squad/ title=创建Squad class=sidelist><a href=https://ocgi.github.io/zh/docs/getting-started/squad/>创建Squad</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/getting-started/gpa/ title="Create a GeneralPodAutoscaler" class=sidelist><a href=https://ocgi.github.io/zh/docs/getting-started/gpa/>Create a GeneralPodAutoscaler</a></li></ul></li><li data-nav-id=https://ocgi.github.io/zh/docs/guides/ title=Guides class=sidelist><a href=https://ocgi.github.io/zh/docs/guides/>Guides</a><ul><li data-nav-id=https://ocgi.github.io/zh/docs/guides/squad_details/ title=Squad介绍 class=sidelist><a href=https://ocgi.github.io/zh/docs/guides/squad_details/>Squad介绍</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/guides/gpa/ title=GeneralPodAutoscaler介绍 class=sidelist><a href=https://ocgi.github.io/zh/docs/guides/gpa/>GeneralPodAutoscaler介绍</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/guides/autoscaling_flow/ title=GameServer自动伸缩流程 class=sidelist><a href=https://ocgi.github.io/zh/docs/guides/autoscaling_flow/>GameServer自动伸缩流程</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/guides/squad-scaledown-priority/ title=设置GamerServer缩容的优先级 class="sidelist
active"><a href=https://ocgi.github.io/zh/docs/guides/squad-scaledown-priority/>设置GamerServer缩容的优先级</a></li></ul></li><li data-nav-id=https://ocgi.github.io/zh/docs/reference/ title=Reference class=sidelist><a href=https://ocgi.github.io/zh/docs/reference/>Reference</a><ul><li data-nav-id=https://ocgi.github.io/zh/docs/reference/sdk/ title="Carrier SDK" class=sidelist><a href=https://ocgi.github.io/zh/docs/reference/sdk/>Carrier SDK</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/reference/gpa_webhook/ title="GPA Webhook示例" class=sidelist><a href=https://ocgi.github.io/zh/docs/reference/gpa_webhook/>GPA Webhook示例</a></li></ul></li><li data-nav-id=https://ocgi.github.io/zh/docs/examples/ title=Examples class=sidelist><a href=https://ocgi.github.io/zh/docs/examples/>Examples</a></li><li data-nav-id=https://ocgi.github.io/zh/docs/faq/ title="Frequently Asked Questions" class=sidelist><a href=https://ocgi.github.io/zh/docs/faq/>Frequently Asked Questions</a></li></ul></li></ul></li></ul></div></div><div class=col-lg-9><div class="p-lg-5 p-4 bg-white"><h1 class=mb-5>设置GamerServer缩容的优先级</h1><div class=content><h2 id=背景>背景</h2><p>一般来说，每个游戏服务器上的玩家数量会不同。当我们缩容时，可以选择用户玩家少的副本，进行删除。这样，可以让应用侧的缩容开销更小，同时，也可以提高底层资源的利用效率。</p><p>我们可以根据一些业务侧指标，给每个游戏服务器设置一定的优先级。缩容时，我们选择优先级低的副本删除。</p><h2 id=核心方案>核心方案</h2><ol><li><p>给GameServer增加carrier.ocgi.dev/gs-deletion-cost(int64) annotation， annotation可以由用户调用sdk加上，或者由我们的组件cost-server加上。</p><ul><li>cost-server根据squad里指定的 carrier.ocgi.dev/gs-cost-metrics-name annotation 从metric server获取数据， 给gs加上carrier.ocgi.dev/gs-deletion-cost annotation。</li><li>如果GameServer未设置carrier.ocgi.dev/gs-deletion-cost 按照Int64 Max计算。</li><li>如果所有GameServer都未设置，进入原先的逻辑，优先选择节点上GameServer较少的节点上的进行缩容，或者按照创建时间最老进行缩容。</li></ul></li><li><p>carrier controller，按照该值从小到大顺序排序， 缩容掉top N。</p></li></ol><h2 id=cost-server-简介>cost-server 简介</h2><ol><li><code>cost-server</code>watch <code>Squad</code>的创建和更新；</li><li><code>cost-server</code>从名为<code>carrier.ocgi.dev/gs-cost-metrics-name</code>的annotation获取对应的metric名；</li><li>如果metric是<code>cpu</code> 或者 <code>memory</code>，<code>cost-server</code>将从<code>metric server</code>获取数据；如果是其余metric将从<code>custom metric server</code>获取数据；</li><li>最终的数据将会写到GameServer的annotation上，例如：<code>carrier.ocgi. dev/gs-deletion-cost: "2101248000"</code>；</li></ol><h2 id=使用方式>使用方式</h2><ol><li>如果是使用<code>cpu</code>、<code>memory</code>等指标，用户用只需要在Squad上指定<code>carrier.ocgi.dev/gs-cost-metrics-name</code>；</li><li>如果用户需要使用自定义指标，如<code>连接数</code>等，用户可以采用以下2种方式之一：</li></ol><ul><li>给Squad加上<code>carrier.ocgi.dev/gs-cost-metrics-name: 连接数</code>, 该方式存在一定延迟</li><li>借助SDK的SetAnnotation方法, 给每个GameServer设置<code>carrier.ocgi.dev/gs-deletion-cost</code></li></ul><h2 id=示例>示例</h2><p>使用cost-server自动给GameServer加<code>cost</code></p><h3 id=创建-squad>创建 squad</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># cat &lt;&lt;EOF | kubectl apply -f -</span>
apiVersion: carrier.ocgi.dev/v1alpha1
kind: Squad
metadata:
  annotations:
    carrier.ocgi.dev/gs-cost-metrics-name: memory
    network.cni/networkname: tke-direct-eni
  name: squad2
spec:
  replicas: <span style=color:#ae81ff>4</span>
  scheduling: MostAllocated
  selector:
    matchLabels:
      carrier.ocgi.dev/squad: squad2
  template:
    metadata:
      annotations:
        network.cni/networkname: tke-direct-eni
      labels:
        foo: bar
    spec:
      health:
        disabled: true
      ports:
        - container: simple-tcp
          containerPort: <span style=color:#ae81ff>7654</span>
          name: default
          protocol: TCP
      template:
        spec:
          containers:
            - image: ocgi/simple-tcp:0.1
              name: server
          serviceAccountName: carrier-sdk
</code></pre></div><h3 id=查看-gameservers>查看 GameServers</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># kubectl get gs -o wide</span>
NAME                      STATE     ADDRESS         PORT   EXTERNALIP   PORTRANGE     NODE            AGE
squad2-56fbd4d75d-4js2f   Running   192.168.113.169                                   192.168.0.115   64m
squad2-56fbd4d75d-cqxtz   Running   192.168.113.165                                   192.168.0.115   64m
squad2-56fbd4d75d-gsh76   Running   192.168.113.166                                   192.168.0.129   64m
squad2-56fbd4d75d-mmcgf   Running   192.168.113.168                                   192.168.0.213   64m
</code></pre></div><h3 id=查看-cost>查看 Cost</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># kubectl get gs -o custom-columns=&#34;Name&#34;:&#34;.metadata.name&#34;,&#34;Cost&#34;:&#34;.metadata.annotations.carrier\.ocgi\.dev/gs-deletion-cost&#34;,&#34;UpdateTime&#34;:&#34;.metadata.annotations.carrier\.ocgi\.dev/deletion-cost-update-time&#34;</span>
Name                      Cost         UpdateTime
squad2-56fbd4d75d-4js2f   <span style=color:#ae81ff>2101248000</span>   2021-04-15 08:20:58 +0000 UTC
squad2-56fbd4d75d-cqxtz   <span style=color:#ae81ff>2191360000</span>   2021-04-15 08:20:58 +0000 UTC
squad2-56fbd4d75d-gsh76   <span style=color:#ae81ff>2007040000</span>   2021-04-15 08:20:58 +0000 UTC
squad2-56fbd4d75d-mmcgf   <span style=color:#ae81ff>2068480000</span>   2021-04-15 08:20:58 +0000 UTC
</code></pre></div><h3 id=缩容>缩容</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>kubectl scale sqd squad2 --replicas<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span>
</code></pre></div><h3 id=再次查看cost>再次查看Cost</h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=color:#75715e># kubectl get gs -o custom-columns=&#34;Name&#34;:&#34;.metadata.name&#34;,&#34;Cost&#34;:&#34;.metadata.annotations.carrier\.ocgi\.dev/gs-deletion-cost&#34;,&#34;UpdateTime&#34;:&#34;.metadata.annotations.carrier\.ocgi\.dev/deletion-cost-update-time&#34;</span>
Name                      Cost         UpdateTime
squad2-56fbd4d75d-4js2f   <span style=color:#ae81ff>2101248000</span>   2021-04-15 08:21:43 +0000 UTC
squad2-56fbd4d75d-cqxtz   <span style=color:#ae81ff>2191360000</span>   2021-04-15 08:21:43 +0000 UTC
squad2-56fbd4d75d-mmcgf   <span style=color:#ae81ff>2068480000</span>   2021-04-15 08:21:43 +0000 UTC
</code></pre></div><p>可以看到，最小<code>Cost</code>的副本被删除。</p></div><p class="post-meta border-bottom pb-3 mb-0 mt-3">Updated on 2021-06-08</p></p><nav class="pagination mt-3"><a class="nav nav-prev" href=https://ocgi.github.io/zh/docs/guides/autoscaling_flow/><i class="ti-arrow-left mr-2"></i> <span class="d-none d-md-block">GameServer自动伸缩流程</span></a>
<a class="nav nav-next" href=https://ocgi.github.io/zh/docs/reference/><span class="d-none d-md-block">Reference</span><i class="ti-arrow-right ml-2"></i></a></nav></div></div></div></div></section><footer class="section pb-4"><div class=container><div class="row align-items-center"><div class="col-md-8 text-md-left text-center"><p class="mb-md-0 mb-4">Copyright © 2021 The OCGI Authors</p></div><div class="col-md-4 text-md-right text-center"><ul class=list-inline></ul></div></div></div></footer><script src=https://ocgi.github.io/js/script.min.js></script></body></html>